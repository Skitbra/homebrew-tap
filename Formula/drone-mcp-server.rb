# typed: false
# frozen_string_literal: true

require "download_strategy"
require "utils/formatter"
require "utils/github"
require "json"

# Custom download strategy for private GitHub releases
class GitHubPrivateRepositoryReleaseDownloadStrategy < CurlDownloadStrategy
  def initialize(url, name, version, **meta)
    super
    set_github_token
    parse_url_pattern
  end

  def set_github_token
    @github_token = ENV["HOMEBREW_GITHUB_API_TOKEN"]
    unless @github_token
      raise CurlDownloadStrategyError, "HOMEBREW_GITHUB_API_TOKEN is required for private repository releases"
    end
  end

  def parse_url_pattern
    url_pattern = %r{https://github\.com/([^/]+)/([^/]+)/releases/download/([^/]+)/(.+)}
    unless @url =~ url_pattern
      raise CurlDownloadStrategyError, "Invalid GitHub release URL pattern: #{@url}"
    end
    @owner = Regexp.last_match(1)
    @repo = Regexp.last_match(2)
    @tag = Regexp.last_match(3)
    @filename = Regexp.last_match(4)
  end

  def download_url
    "https://api.github.com/repos/#{@owner}/#{@repo}/releases/assets/#{asset_id}"
  end

  def asset_id
    @asset_id ||= begin
      release_url = "https://api.github.com/repos/#{@owner}/#{@repo}/releases/tags/#{@tag}"
      release_json = `curl -s -H "Authorization: token #{@github_token}" "#{release_url}"`
      unless $?.success?
        raise CurlDownloadStrategyError, "Failed to fetch release #{@tag}: #{$?}"
      end
      release = JSON.parse(release_json)
      asset = release["assets"].find { |a| a["name"] == @filename }
      unless asset
        raise CurlDownloadStrategyError, "Asset #{@filename} not found in release #{@tag}"
      end
      asset["id"]
    end
  end

  def _fetch(url: nil, resolved_url: nil, timeout: nil)
    curl_download download_url, "--header", "Authorization: token #{@github_token}", "--header", "Accept: application/octet-stream", to: temporary_path
  end
end

# This file was generated by GoReleaser. DO NOT EDIT.
class DroneMcpServer < Formula
  desc "MCP server for read-only Drone CI/CD inspection"
  homepage "https://github.com/sqsp/drone-mcp-server"
  version "0.7.1"
  license "MIT"

  on_macos do
    if Hardware::CPU.intel?
      url "https://github.com/sqsp/drone-mcp-server/releases/download/v0.7.1/drone-mcp-server-0.7.1-darwin-amd64.tar.gz", using: GitHubPrivateRepositoryReleaseDownloadStrategy
      sha256 "c01ae014c324c47052712d5c4970395a80d07f56fdde10777e9b4a242e410d0e"

      def install
        bin.install "drone-mcp-server"
      end
    end
    if Hardware::CPU.arm?
      url "https://github.com/sqsp/drone-mcp-server/releases/download/v0.7.1/drone-mcp-server-0.7.1-darwin-arm64.tar.gz", using: GitHubPrivateRepositoryReleaseDownloadStrategy
      sha256 "1be950cadbfc8a9540ae36130da86671e791da9332873830bb8091c5d09b3cc2"

      def install
        bin.install "drone-mcp-server"
      end
    end
  end

  on_linux do
    if Hardware::CPU.intel? && Hardware::CPU.is_64_bit?
      url "https://github.com/sqsp/drone-mcp-server/releases/download/v0.7.1/drone-mcp-server-0.7.1-linux-amd64.tar.gz", using: GitHubPrivateRepositoryReleaseDownloadStrategy
      sha256 "1ba2f95bcce4e8b0c5045f0e659bcae8c976107d6fb2e8d78116b8f9094cdbfb"

      def install
        bin.install "drone-mcp-server"
      end
    end
    if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
      url "https://github.com/sqsp/drone-mcp-server/releases/download/v0.7.1/drone-mcp-server-0.7.1-linux-arm64.tar.gz", using: GitHubPrivateRepositoryReleaseDownloadStrategy
      sha256 "0f259b23cd839d65d2309a1598d6e045cad2b6d1a727b50d309cdccf517880fd"

      def install
        bin.install "drone-mcp-server"
      end
    end
  end

  def caveats
    <<~EOS
      drone-mcp-server requires configuration:

      1. Drone credentials:
         export DRONE_SERVER=https://delivery.squarespace.net
         export DRONE_TOKEN=<your_drone_token>

      2. For IDE integration, see:
         https://github.com/sqsp/drone-mcp-server/blob/master/README.md#ide-integration
    EOS
  end

  test do
    system "#{bin}/drone-mcp-server --version"
  end
end
